end) AS weight
from icustays ie
left join chartevents c
on ie.icustay_id = c.icustay_id
where valuenum IS NOT NULL
and itemid IN
(
762, 763, 3723, 3580,
3581,
3582,
226512 -- Metavision: Admission Weight (Kg)
)
and valuenum != 0
and charttime between ie.intime - interval '1' day and ie.intime + interval '1' day
and c.error IS DISTINCT FROM 1
group by ie.icustay_id
), echo2 as
(
select echo.subject_id, ie.icustay_id, avg(weight * 0.45359237) as weight
from icustays ie
left join echodata echo
on ie.hadm_id = echo.hadm_id
and echo.charttime > ie.intime - interval '7' day
and echo.charttime < ie.intime + interval '1' day
where weight is not null
group by ie.icustay_id, echo.subject_id
), creation_poids as
(
select ec.subject_id, ec.icustay_id, coalesce(wt.weight,ec.weight) as poids
from poids as wt
inner join echo2 as ec
on wt.icustay_id = ec.icustay_id
)
select distinct wt.subject_id, wt.icustay_id ,ca.age, ca.gender, wt.poids
from creation_age ca
inner join creation_poids as wt
on wt.subject_id = ca.subject_id
where age between'18' and '90'
;"
)
# Dialyse  : mettre dans les infos patients
dialyse <- dbGetQuery(con,"
WITH
cv as
(
select ie.icustay_id
, max(
case
when ce.itemid in (152,148,149,146,147,151,150) and value is not null then 1
when ce.itemid in (229,235,241,247,253,259,265,271) and value = 'Dialysis Line' then 1
when ce.itemid = 582 and value in ('CAVH Start','CAVH D/C','CVVHD Start','CVVHD D/C','Hemodialysis st','Hemodialysis end') then 1
else 0 end
) as RRT
from icustays ie
inner join chartevents ce
on ie.icustay_id = ce.icustay_id
and ce.itemid in
(
152 -- 'Dialysis Type';61449
,148 -- 'Dialysis Access Site';60335
,149 -- 'Dialysis Access Type';60030
,146 -- 'Dialysate Flow ml/hr';57445
,147 -- 'Dialysate Infusing';56605
,151 -- 'Dialysis Site Appear';37345
,150 -- 'Dialysis Machine';27472
,229 -- INV Line#1 [Type]
,235 -- INV Line#2 [Type]
,241 -- INV Line#3 [Type]
,247 -- INV Line#4 [Type]
,253 -- INV Line#5 [Type]
,259 -- INV Line#6 [Type]
,265 -- INV Line#7 [Type]
,271 -- INV Line#8 [Type]
,582 -- Procedures
)
and ce.value is not null
where ie.dbsource = 'carevue'
-- exclude rows marked as error
and ce.error IS DISTINCT FROM 1
group by ie.icustay_id
)
, mv_ce as
(
select icustay_id
, 1 as RRT
from chartevents ce
where itemid in
(
-- Checkboxes
225126 -- | Dialysis patient                                  | Adm History/FHPA        | chartevents        | Checkbox
, 226118 -- | Dialysis Catheter placed in outside facility      | Access Lines - Invasive | chartevents        | Checkbox
, 227357 -- | Dialysis Catheter Dressing Occlusive              | Access Lines - Invasive | chartevents        | Checkbox
, 225725 -- | Dialysis Catheter Tip Cultured                    | Access Lines - Invasive | chartevents        | Checkbox
-- Numeric values
, 226499 -- | Hemodialysis Output                               | Dialysis                | chartevents        | Numeric
, 224154 -- | Dialysate Rate                                    | Dialysis                | chartevents        | Numeric
, 225810 -- | Dwell Time (Peritoneal Dialysis)                  | Dialysis                | chartevents        | Numeric
, 227639 -- | Medication Added Amount  #2 (Peritoneal Dialysis) | Dialysis                | chartevents        | Numeric
, 225183 -- | Current Goal                     | Dialysis | chartevents        | Numeric
, 227438 -- | Volume not removed               | Dialysis | chartevents        | Numeric
, 224191 -- | Hourly Patient Fluid Removal     | Dialysis | chartevents        | Numeric
, 225806 -- | Volume In (PD)                   | Dialysis | chartevents        | Numeric
, 225807 -- | Volume Out (PD)                  | Dialysis | chartevents        | Numeric
, 228004 -- | Citrate (ACD-A)                  | Dialysis | chartevents        | Numeric
, 228005 -- | PBP (Prefilter) Replacement Rate | Dialysis | chartevents        | Numeric
, 228006 -- | Post Filter Replacement Rate     | Dialysis | chartevents        | Numeric
, 224144 -- | Blood Flow (ml/min)              | Dialysis | chartevents        | Numeric
, 224145 -- | Heparin Dose (per hour)          | Dialysis | chartevents        | Numeric
, 224149 -- | Access Pressure                  | Dialysis | chartevents        | Numeric
, 224150 -- | Filter Pressure                  | Dialysis | chartevents        | Numeric
, 224151 -- | Effluent Pressure                | Dialysis | chartevents        | Numeric
, 224152 -- | Return Pressure                  | Dialysis | chartevents        | Numeric
, 224153 -- | Replacement Rate                 | Dialysis | chartevents        | Numeric
, 224404 -- | ART Lumen Volume                 | Dialysis | chartevents        | Numeric
, 224406 -- | VEN Lumen Volume                 | Dialysis | chartevents        | Numeric
, 226457 -- | Ultrafiltrate Output             | Dialysis | chartevents        | Numeric
)
and ce.valuenum > 0 -- also ensures it's not null
-- exclude rows marked as error
and ce.error IS DISTINCT FROM 1
group by icustay_id
)
, mv_ie as
(
select icustay_id
, 1 as RRT
from inputevents_mv
where itemid in
(
227536 --	KCl (CRRT)	Medications	inputevents_mv	Solution
, 227525 --	Calcium Gluconate (CRRT)	Medications	inputevents_mv	Solution
)
and amount > 0 -- also ensures it's not null
group by icustay_id
)
, mv_de as
(
select icustay_id
, 1 as RRT
from datetimeevents
where itemid in
(
-- TODO: unsure how to handle 'Last dialysis'
--  225128 -- | Last dialysis                                     | Adm History/FHPA        | datetimeevents     | Date time
225318 -- | Dialysis Catheter Cap Change                      | Access Lines - Invasive | datetimeevents     | Date time
, 225319 -- | Dialysis Catheter Change over Wire Date           | Access Lines - Invasive | datetimeevents     | Date time
, 225321 -- | Dialysis Catheter Dressing Change                 | Access Lines - Invasive | datetimeevents     | Date time
, 225322 -- | Dialysis Catheter Insertion Date                  | Access Lines - Invasive | datetimeevents     | Date time
, 225324 -- | Dialysis CatheterTubing Change                    | Access Lines - Invasive | datetimeevents     | Date time
)
group by icustay_id
)
, mv_pe as
(
select icustay_id
, 1 as RRT
from procedureevents_mv
where itemid in
(
225441 -- | Hemodialysis                                      | 4-Procedures            | procedureevents_mv | Process
, 225802 -- | Dialysis - CRRT                                   | Dialysis                | procedureevents_mv | Process
, 225803 -- | Dialysis - CVVHD                                  | Dialysis                | procedureevents_mv | Process
, 225805 -- | Peritoneal Dialysis                               | Dialysis                | procedureevents_mv | Process
, 224270 -- | Dialysis Catheter                                 | Access Lines - Invasive | procedureevents_mv | Process
, 225809 -- | Dialysis - CVVHDF                                 | Dialysis                | procedureevents_mv | Process
, 225955 -- | Dialysis - SCUF                                   | Dialysis                | procedureevents_mv | Process
, 225436 -- | CRRT Filter Change               | Dialysis | procedureevents_mv | Process
)
group by icustay_id
)
select ie.subject_id, ie.hadm_id, ie.icustay_id
, case
when cv.RRT = 1 then 1
when mv_ce.RRT = 1 then 1
when mv_ie.RRT = 1 then 1
when mv_de.RRT = 1 then 1
when mv_pe.RRT = 1 then 1
else 0
end as RRT
from icustays ie
left join cv
on ie.icustay_id = cv.icustay_id
left join mv_ce
on ie.icustay_id = mv_ce.icustay_id
left join mv_ie
on ie.icustay_id = mv_ie.icustay_id
left join mv_de
on ie.icustay_id = mv_de.icustay_id
left join mv_pe
on ie.icustay_id = mv_pe.icustay_id
order by ie.icustay_id;"
)
# Type réanimation (première unité)
type_reanimation <- dbGetQuery(con,"
select subject_id, icustay_id, los,
case
when first_careunit = 'MICU' then 1
when first_careunit = 'SICU' then 2
when first_careunit = 'TSICU' then 3
when first_careunit = 'CSRU' then 4
when first_careunit = 'NICU' then 5
else 6 end as care_unit
from icustays
;")
# Score de gravité : SAPSII et SOFA
scores <- dbGetQuery(con,"
select sa.subject_id, sa.icustay_id, sa.sapsii, so.sofa
from sapsii sa
inner join sofa so
on sa.icustay_id = so.icustay_id;"
)
#######################################################
# -------- Infos à l'admission
#######################################################
infos_admission <- demographique %>%
merge(scores, by = c("subject_id","icustay_id")) %>%
merge(type_reanimation, by = c("subject_id","icustay_id")) %>%
merge(dialyse, by = c("subject_id","icustay_id"))
# 14293 patients
saveRDS(infos_admission, paste0(dest_data,"infos_admission.RDS"))
#######################################################
# -------- Informations sur les patients : données réactualisées
#######################################################
# Lactate réactualisés
lactate <- dbGetQuery(con,"
select distinct ic.subject_id, ic.icustay_id,
le.hadm_id,le.charttime, le.value,le.flag,
li.itemid, li.label,
RANK() OVER (PARTITION BY ic.icustay_id ORDER BY le.charttime ASC) AS rank
from icustays ic
inner join labevents le
on  ic.hadm_id = le.hadm_id
inner join d_labitems li
on le.itemid = li.itemid
where le.itemid = 50813;"
)
# Vasopresseurs
amine <- dbGetQuery(con,"
select * from vasopressordurations
")
# Sédation
sedation <- dbGetQuery(con,"
select subject_id, icustay_id, startdate, enddate,
case
when drug like 'Propofol' or
drug like 'propofol' or
drug like 'Midazolam' or
drug like 'Diprivan' or
drug like 'Hypnovel' or
drug like 'Versed' or
drug like 'Thiopental' or
drug like 'Ketamin' or
drug like 'Ketalar' or
drug like 'Etomidate' or
drug like 'Amidate' then 1
else 0 end as sedation
from prescriptions
;")
# Curarisé
curare <- dbGetQuery(con,"
select subject_id, icustay_id, startdate, enddate,
case
when drug like 'Cisatracrium' or
drug like 'Atracrium' or
drug like 'Tracrium' or
drug like 'Midazolam' or
drug like 'Nimbex' or
drug like 'Rocuronium' or
drug like 'Esmeron' or
drug like 'Succinylcholine' then 1
else 0 end as curare
from prescriptions
;")
# Ventilation
ventilation <- dbGetQuery(con,"
select subject_id,icustay_id, charttime
-- case statement determining whether it is an instance of mech vent
, max(
case
when itemid is null or value is null then 0 -- can't have null values
when itemid = 720 and value != 'Other/Remarks' THEN 1  -- VentTypeRecorded
when itemid = 223848 and value != 'Other' THEN 1
when itemid = 223849 then 1 -- ventilator mode
when itemid = 467 and value = 'Ventilator' THEN 1 -- O2 delivery device == ventilator
when itemid = 648 and value = 'Intubated/trach' THEN 1 -- Speech = intubated
when itemid = 223900 and value = 'No Response-ETT' THEN 1
when itemid in
(
445, 448, 449, 450, 1340, 1486, 1600, 224687 -- minute volume
, 639, 654, 681, 682, 683, 684,224685,224684,224686 -- tidal volume
, 218,436,535,444,459,224697,224695,224696,224746,224747
, 221,1,1211,1655,2000,226873,224738,224419,224750,227187 -- Insp pressure
, 543 -- PlateauPressure
, 5865,5866,224707,224709,224705,224706 -- APRV pressure
, 60,437,505,506,686,220339,224700 -- PEEP
, 3459 -- high pressure relief
, 501,502,503,224702 -- PCV
, 223,667,668,669,670,671,672 -- TCPCV
, 157,158,1852,3398,3399,3400,3401,3402,3403,3404,8382,227809,227810 -- ETT
, 224701 -- PSVlevel
)
THEN 1
else 0
end
) as MechVent
, max(
case when itemid is null or value is null then 0
-- extubated indicates ventilation event has ended
when itemid = 640 and value = 'Extubated' then 1
when itemid = 640 and value = 'Self Extubation' then 1
-- initiation of oxygen therapy indicates the ventilation has ended
when itemid = 226732 and value in
(
'Nasal cannula', -- 153714 observations
'Face tent', -- 24601 observations
'Aerosol-cool', -- 24560 observations
'Trach mask ', -- 16435 observations
'High flow neb', -- 10785 observations
'Non-rebreather', -- 5182 observations
'Venti mask ', -- 1947 observations
'Medium conc mask ', -- 1888 observations
'T-piece', -- 1135 observations
'High flow nasal cannula', -- 925 observations
'Ultrasonic neb', -- 9 observations
'Vapomist' -- 3 observations
) then 1
when itemid = 467 and value in
(
'Cannula', -- 278252 observations
'Nasal Cannula', -- 248299 observations
'None', -- 95498 observations
'Face Tent', -- 35766 observations
'Aerosol-Cool', -- 33919 observations
'Trach Mask', -- 32655 observations
'Hi Flow Neb', -- 14070 observations
'Non-Rebreather', -- 10856 observations
'Venti Mask', -- 4279 observations
'Medium Conc Mask', -- 2114 observations
'Vapotherm', -- 1655 observations
'T-Piece', -- 779 observations
'Hood', -- 670 observations
'Hut', -- 150 observations
'TranstrachealCat', -- 78 observations
'Heated Neb', -- 37 observations
'Ultrasonic Neb' -- 2 observations
) then 1
else 0
end
)
as Extubated
, max(
case when itemid is null or value is null then 0
when itemid = 640 and value = 'Self Extubation' then 1
else 0
end
)
as SelfExtubated
from chartevents ce
where ce.value is not null
-- exclude rows marked as error
-- and ce.error IS DISTINCT FROM 1
and itemid in
(
-- the below are settings used to indicate ventilation
648, 223900 -- speech
, 720, 223849 -- vent mode
, 223848 -- vent type
, 445, 448, 449, 450, 1340, 1486, 1600, 224687 -- minute volume
, 639, 654, 681, 682, 683, 684,224685,224684,224686 -- tidal volume
, 218,436,535,444,224697,224695,224696,224746,224747
, 221,1,1211,1655,2000,226873,224738,224419,224750,227187 -- Insp pressure
, 543 -- PlateauPressure
, 5865,5866,224707,224709,224705,224706 -- APRV pressure
, 60,437,505,506,686,220339,224700 -- PEEP
, 3459 -- high pressure relief
, 501,502,503,224702 -- PCV
, 223,667,668,669,670,671,672 -- TCPCV
, 157,158,1852,3398,3399,3400,3401,3402,3403,3404,8382,227809,227810 -- ETT
, 224701 -- PSVlevel
-- the below are settings used to indicate extubation
, 640 -- extubated
-- the below indicate oxygen/NIV, i.e. the end of a mechanical vent event
, 468 -- O2 Delivery Device#2
, 469 -- O2 Delivery Mode
, 470 -- O2 Flow (lpm)
, 471 -- O2 Flow (lpm) #2
, 227287 -- O2 Flow (additional cannula)
, 226732 -- O2 Delivery Device(s)
, 223834 -- O2 Flow
-- used in both oxygen + vent calculation
, 467 -- O2 Delivery Device
)
group by subject_id , icustay_id, charttime
UNION
-- add in the extubation flags from procedureevents_mv
-- note that we only need the start time for the extubation
-- (extubation is always charted as ending 1 minute after it started)
select subject_id,icustay_id, starttime as charttime
, 0 as MechVent
, 1 as Extubated
, case when itemid = 225468 then 1 else 0 end as SelfExtubated
from procedureevents_mv
where itemid in
(227194, 225468 , 225477 );"
)
# Expension volémique ---- demander Thaïs
# hypovolemie <- dbGetQuery(con,"
# select subject_id, icustay_id, startdate, enddate, drug
# from prescriptions
# where
# drug like '' or
# drug like '' or
# drug like '' or
# drug like '' or
# drug like '' or
# drug like '' or
# drug like '' or
# drug like ''
# ;")
# saveRDS(sedation, paste0(dest_data,"sedation.RDS"))
# saveRDS(lactate, paste0(dest_data,"lactate.RDS"))
# saveRDS(amine, paste0(dest_data,"amine.RDS"))
# saveRDS(curare, paste0(dest_data,"curare.RDS"))
# saveRDS(ventilation, paste0(dest_data,"ventilation.RDS"))
#######################################################
# -------- Infos réactualisées
#######################################################
# filtre les données réactualisées par rapport aux patients
# pour lesquels les infos à l'admission sont dispos
curare <- filtre_id(curare)
sedation <- filtre_id(sedation)
amine <- filtre_id(amine)
lactate <- filtre_id(lactate)
dialyse <- filtre_id(dialyse)
ventilation <- filtre_id(ventilation)
# Merge :  Date
df_date <- curare %>%
full_join(sedation, by = c("subject_id","icustay_id","startdate","enddate")) %>%
melt(id.vars = c("subject_id", "icustay_id","startdate", "enddate"),
variable.name = "label")
df_date$enddate <- as.Date(df_date$enddate,"%Y-%m-%d")
df_date$startdate <- as.Date(df_date$startdate,"%Y-%m-%d")
# Merge :  Temps
ventilation$value <- as.numeric(as.character(ventilation$extubated))
ventilation$value <- ifelse(ventilation$value =="1",0,1)
lactate$value <- as.numeric(as.character(lactate$value))
df_chart <- full_join(lactate, ventilation,
by = c("subject_id","icustay_id", "charttime","value")) %>%
subset(select = c("subject_id","icustay_id","hadm_id",
"charttime","label","value"))
df_chart$label <- as.factor(ifelse(is.na(df_chart$label),
"ventilation","lactate"))
df_chart$startdate <- df_chart$enddate <- as.Date(
str_extract(df_chart$charttime, ".*(?= )"),"%Y-%m-%d")
# Merge :  Date et Temps
temp <- full_join(df_date,df_chart,
by = c("subject_id","icustay_id","startdate","enddate","label","value")) %>%
subset(is.na(startdate)==F) %>%
unique()
# Pas complet
sous_temp <- subset(temp, is.na(temp$charttime))
sous_temp$charttime <- paste0(sous_temp$startdate," 09:00:00")
# Complet
sous_temp_complet <- subset(temp, is.na(temp$charttime)==F)
sous_temp_complet$charttime <- as.character(sous_temp_complet$charttime)
# Rbind
new.temp <- rbind(sous_temp,sous_temp_complet)
time_definition <- str_extract(new.temp$charttime,"( ).*")
new.temp$starttime <- as.character(paste0(new.temp$startdate,time_definition))
new.temp$endtime <-  as.character(paste0(new.temp$enddate,time_definition))
# Merge : Intervalle de temps
amine$value <- amine$vasonum
amine$label <- "amine"
amine$starttime <- as.character(amine$starttime)
amine$endtime <- as.character(amine$endtime)
amine$startdate <- as.Date(str_extract(amine$starttime, ".*(?= )"),"%Y-%m-%d")
amine$enddate <- as.Date(str_extract(amine$endtime, ".*(?= )"),"%Y-%m-%d")
amine$charttime <- as.character(amine$starttime)
amine <- subset(amine, select = c("icustay_id","starttime","endtime","value",
"label","startdate","enddate", "charttime"))
infos_reactualisee <- full_join(new.temp, amine,
by = c("icustay_id","starttime","endtime", "charttime",
"value", "label","startdate", "enddate"))  %>%
subset( select = c("subject_id","icustay_id","startdate","enddate",
"starttime","endtime","charttime","label","value"))
manquant <- aggr(infos_reactualisee)
print(manquant$missings)
# 19 valeurs de lactates manquantes car erreur lors de l'examen biologique
# 11 236 valeurs de subject_id manquantes
# Imputation des subject_id
id <- dbGetQuery(con,"
select subject_id as id, icustay_id
from icustays;"
)
infos_reactualisee <- infos_reactualisee %>%
left_join(id, by = "icustay_id")%>%
subset( select = c("id","icustay_id","startdate","enddate",
"starttime","endtime","charttime","label","value"))
# RDS
saveRDS(infos_reactualisee, paste0(dest_data,"infos_reactualisee.RDS"))
#######################################################
# -------- Fichier global avec toutes les informations
#######################################################
# unique séjour
setDT(infos_admission)
setDT(infos_reactualisee)
infos_admission <- unique(infos_admission, by = "icustay_id")
infos <- left_join(lol, infos_reactualisee, by ="icustay_id")
saveRDS(infos, paste0(dest_data,"infos_mimic3.RDS"))
infos <- left_join(infos_admission, infos_reactualisee, by ="icustay_id")
saveRDS(infos, paste0(dest_data,"infos_mimic3.RDS"))
View(infos)
